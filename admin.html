<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Kwarran - ScoutLive</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .swal2-popup { font-family: sans-serif; border-radius: 1rem; }
        
        /* CSS CETAK */
        @media print {
            .no-print, nav, #loginOverlay, .tab-menu, .swal2-container { display: none !important; }
            #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; color: black; }
            body { background: white; padding: 0; margin: 0; }
            table { width: 100%; border-collapse: collapse; border: 1px solid black; }
            th, td { border: 1px solid black; padding: 4px; text-align: left; font-size: 11px; } 
            th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; text-align: center; font-weight: bold; }
            .text-center { text-align: center; } .text-right { text-align: right; }
            .kop-surat { text-align: center; margin-bottom: 10px; border-bottom: 3px double black; padding-bottom: 5px; }
            @page { size: landscape; margin: 10mm; }
        }
        #printArea { display: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <script>
        // PASTE URL API ANDA DI BAWAH INI
        const API_URL = "https://script.google.com/macros/s/AKfycbyfB19FroqDqmvn7JfSjxNQ03NzPB6_dgajXxGms_bwD51-Crhet615fcWG3xJVC4Uv/exec"; 
    </script>

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center border-t-4 border-red-600">
            <div class="mx-auto bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="shield" class="w-8 h-8 text-red-600"></i>
            </div>
            <h2 class="text-xl font-bold mb-1">Admin Kwarran</h2>
            <p class="text-sm text-slate-500 mb-6">Panel Kontrol Data Lomba</p>
            <input type="password" id="adminPass" class="w-full p-3 border rounded-lg mb-4 text-center font-bold tracking-widest outline-none focus:ring-2 focus:ring-red-500" placeholder="PASSWORD">
            <button id="btnLoginBtn" class="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-lg font-bold transition transform active:scale-95">MASUK</button>
        </div>
    </div>

    <nav class="bg-white shadow-sm border-b sticky top-0 z-40 no-print">
        <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="font-bold text-lg flex items-center gap-2 text-slate-800">
                <i data-lucide="shield" class="w-6 h-6 text-red-600"></i> Admin<span class="text-red-600">Kwarran</span>
            </div>
            <div class="flex gap-2">
                <button id="btnRefresh" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200" title="Refresh"><i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i></button>
                <button id="btnLogout" class="p-2 bg-red-50 rounded-lg hover:bg-red-100 text-red-600" title="Keluar"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 pb-20 space-y-6 no-print">
        
        <div class="flex p-1 bg-slate-200 rounded-xl tab-menu max-w-md mx-auto">
            <button onclick="switchTab('monitor')" id="btn-monitor" class="flex-1 py-2 px-4 rounded-lg font-bold text-sm bg-white shadow-sm text-red-600 transition">üì° Monitor Live</button>
            <button onclick="switchTab('laporan')" id="btn-laporan" class="flex-1 py-2 px-4 rounded-lg font-bold text-sm text-slate-500 hover:text-slate-700 transition">üñ®Ô∏è Laporan & Excel</button>
        </div>

        <div id="tab-monitor" class="space-y-6 animate-fade-in">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Total Input</div>
                    <h3 class="text-2xl font-bold text-slate-800" id="totalData">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Pos Aktif</div>
                    <h3 class="text-2xl font-bold text-green-600" id="activeTaman">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 col-span-2">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Status Sistem</div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-sm font-medium text-slate-600">Online ‚Ä¢ <span id="lastUpdate">-</span></span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-800 text-white p-3 flex justify-between items-center">
                        <h3 class="font-bold flex items-center gap-2"><i data-lucide="user"></i> PUTRA</h3>
                        <span class="text-xs bg-slate-700 px-2 py-1 rounded">Top 5 Live</span>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="livePutra" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-red-700 text-white p-3 flex justify-between items-center">
                        <h3 class="font-bold flex items-center gap-2"><i data-lucide="user-check"></i> PUTRI</h3>
                        <span class="text-xs bg-red-800 px-2 py-1 rounded">Top 5 Live</span>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="livePutri" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b bg-indigo-50 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-indigo-900 flex items-center gap-2"><i data-lucide="table"></i> Matriks Keseluruhan (Live)</h3>
                        <p class="text-xs text-indigo-600 mt-1">Pantau seluruh nilai per pos</p>
                    </div>
                    <select id="matrixLiveFilter" onchange="renderLiveMatrix()" class="p-2 border border-indigo-200 rounded-lg text-xs font-bold bg-white text-indigo-800 outline-none">
                        <option value="Putra">Kategori PUTRA</option>
                        <option value="Putri">Kategori PUTRI</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left border-collapse" id="liveMatrixTable">
                        </table>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold flex items-center gap-2"><i data-lucide="list"></i> Log Input Terakhir</h3>
                </div>
                <div id="logList" class="divide-y divide-slate-100 max-h-[400px] overflow-y-auto"></div>
            </div>
            
            <div class="mt-8 pt-6 border-t border-slate-300 text-center">
                <button onclick="resetAllData()" class="text-red-500 text-xs font-bold hover:text-red-700 flex items-center justify-center gap-1 mx-auto bg-red-50 px-4 py-2 rounded-full border border-red-100"><i data-lucide="trash-2" class="w-3 h-3"></i> RESET DATA LOMBA</button>
            </div>
        </div>

        <div id="tab-laporan" class="space-y-6 hidden animate-fade-in">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-purple-200 bg-purple-50">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-purple-200 p-2 rounded-lg"><i data-lucide="table" class="w-6 h-6 text-purple-700"></i></div>
                    <div>
                        <h3 class="font-bold text-lg text-purple-900">Matriks Rekapitulasi</h3>
                        <p class="text-xs text-purple-600">Format Resmi (No Undi & Ranking di Kanan)</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex gap-2 items-center">
                        <span class="text-xs font-bold w-12 text-slate-500">PUTRA:</span>
                        <button onclick="processRekap('Putra', 'print')" class="flex-1 bg-purple-700 text-white py-2 rounded-lg font-bold hover:bg-purple-800 flex items-center justify-center gap-2 text-xs"><i data-lucide="printer" class="w-3 h-3"></i> Cetak PDF</button>
                        <button onclick="processRekap('Putra', 'excel')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2 text-xs"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel (.xlsx)</button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <span class="text-xs font-bold w-12 text-slate-500">PUTRI:</span>
                        <button onclick="processRekap('Putri', 'print')" class="flex-1 bg-purple-700 text-white py-2 rounded-lg font-bold hover:bg-purple-800 flex items-center justify-center gap-2 text-xs"><i data-lucide="printer" class="w-3 h-3"></i> Cetak PDF</button>
                        <button onclick="processRekap('Putri', 'excel')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2 text-xs"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel (.xlsx)</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-yellow-100 p-2 rounded-lg"><i data-lucide="trophy" class="w-6 h-6 text-yellow-600"></i></div>
                    <div><h3 class="font-bold text-lg">Cetak Klasemen Juara</h3></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="printKlasemen('Putra')" class="bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-slate-700 gap-2 flex justify-center items-center text-sm"><i data-lucide="printer" class="w-4 h-4"></i> JUARA PUTRA</button>
                    <button onclick="printKlasemen('Putri')" class="bg-red-700 text-white py-2 rounded-lg font-bold hover:bg-red-800 gap-2 flex justify-center items-center text-sm"><i data-lucide="printer" class="w-4 h-4"></i> JUARA PUTRI</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-2"><i data-lucide="tent" class="w-5 h-5 text-blue-600"></i><h3 class="font-bold text-sm uppercase">Rekap Nilai Per Pos</h3></div>
                    <div class="flex gap-2">
                        <select id="selectTamanPrint" class="flex-1 p-2 border rounded bg-slate-50 text-xs font-bold"><option value="">Pilih Pos / Taman...</option></select>
                        <button onclick="printRekapTaman()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700"><i data-lucide="printer" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-2"><i data-lucide="users" class="w-5 h-5 text-green-600"></i><h3 class="font-bold text-sm uppercase">Rapor Barung</h3></div>
                    <div class="flex gap-2">
                        <select id="selectBarungPrint" class="flex-1 p-2 border rounded bg-slate-50 text-xs font-bold"><option value="">Pilih Barung...</option></select>
                        <button onclick="printRaporBarung()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700"><i data-lucide="printer" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="printArea">
        <div class="kop-surat">
            <h1 style="font-size: 20px; font-weight: bold; margin: 0;">GERAKAN PRAMUKA</h1>
            <h1 style="font-size: 20px; font-weight: bold; margin: 0;">KWARTIR RANTING SELOGIRI</h1>
            <h2 style="font-size: 14px; margin: 5px 0; font-weight: normal;">LAPORAN HASIL PESTA SIAGA TAHUN 2026</h2>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div style="font-size: 12px;">Hal: <span id="printCategory" style="font-weight: bold;">-</span></div>
            <div style="font-size: 12px;">Waktu Cetak: <span id="printDate"></span></div>
        </div>
        <h3 id="printTitle" style="text-align: center; margin-bottom: 15px; text-transform: uppercase; font-weight: bold; font-size: 16px; text-decoration: underline;">JUDUL LAPORAN</h3>
        <div id="printContent"></div>
        <div style="margin-top: 30px; display: flex; justify-content: space-between; page-break-inside: avoid;">
            <div style="text-align: center; width: 30%; font-size: 12px;"><br>Mengetahui,<br>Ketua Panitia<br><br><br><br><br>____________________</div>
            <div style="text-align: center; width: 30%; font-size: 12px;">Selogiri, <span id="printDateSign"></span><br>Petugas Admin<br><br><br><br><br>____________________</div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        var PASSWORD = "";
        var rawData = []; 
        var masterTaman = []; 
        var masterBarung = [];

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('btnLoginBtn').addEventListener('click', checkLogin);
            document.getElementById('btnRefresh').addEventListener('click', loadAllData);
            document.getElementById('btnLogout').addEventListener('click', logout);
        });

        function checkLogin() {
            var pass = document.getElementById('adminPass').value;
            if(!pass) { Swal.fire('Oops', 'Masukkan Password!', 'error'); return; }
            PASSWORD = pass;
            document.getElementById('loginOverlay').classList.add('hidden');
            loadAllData();
            setInterval(loadAllData, 30000);
            Swal.fire({icon:'success', title:'Login Berhasil', timer:1000, showConfirmButton:false});
        }

        function logout() { location.reload(); }

        function getSafeGender(namaBarung) {
            var info = masterBarung.find(function(b) { return b[1] == namaBarung; });
            if (info && info[3]) return String(info[3]);
            return "?"; 
        }

        // --- PUSAT DATA CALCULATOR (Super Engine) ---
        // Fungsi ini digunakan oleh Live Matrix, Cetak PDF, Excel, dan Top 5.
        function getMatrixData(gender) {
            var barungs = masterBarung.filter(function(b) {
                var g = b[3] ? String(b[3]) : "?"; 
                return g.toLowerCase().includes(gender.toLowerCase());
            });
            var tamans = masterTaman.map(function(t) { return t[1]; }).sort();
            
            var finalData = barungs.map(function(b) {
                var scores = {};
                tamans.forEach(function(t) { scores[t] = 0; });
                var total = 0;
                
                rawData.forEach(function(r) {
                    if(r[2] === b[1]) { scores[r[1]] = parseFloat(r[4]) || 0; } // pakai parseFloat agar support trik desimal
                });
                
                total = Object.values(scores).reduce(function(a,c) { return a+c; }, 0);
                
                // Pembulatan aman untuk tampilan total jika ada koma trik draw
                var displayTotal = total % 1 !== 0 ? total.toFixed(1) : total;

                return { noBarung: b[0], nama: b[1], pangkalan: b[2], scores: scores, total: total, displayTotal: displayTotal };
            });

            finalData.sort(function(a,b) { return b.total - a.total; });
            return { tamans: tamans, data: finalData };
        }

        // --- LOAD SEMUA DATA ---
        async function loadAllData() {
            document.getElementById('lastUpdate').innerText = "Memuat...";
            try {
                // 1. Data Master
                const resMaster = await fetch(API_URL + "?action=getData");
                const jsonMaster = await resMaster.json();
                if(jsonMaster.status === "success") {
                     masterTaman = jsonMaster.data.taman;
                     masterBarung = jsonMaster.data.barung;
                     renderDropdownPrint();
                }

                // 2. Data Nilai Raw
                const resAdmin = await fetch(API_URL + "?action=getAdminData");
                const jsonAdmin = await resAdmin.json();
                if(jsonAdmin.status === "success") {
                    rawData = jsonAdmin.data; 
                    renderStatsAndLog(rawData);
                }

                // 3. Render Komponen Live dari Data yg Diolah
                if(masterBarung.length > 0 && masterTaman.length > 0) {
                    renderLiveKlasemenLocal();
                    renderLiveMatrix();
                }

                document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
            } catch(e) { console.error("Error loading data"); }
        }

        // --- UI RENDERERS ---
        function renderStatsAndLog(data) {
            document.getElementById('totalData').innerText = data.length;
            var tamanSet = new Set(data.map(function(r) { return r[1]; }));
            document.getElementById('activeTaman').innerText = tamanSet.size;
            
            var list = document.getElementById('logList');
            list.innerHTML = "";
            var viewData = data.slice().reverse().slice(0, 30); 
            
            viewData.forEach(function(row) {
                var genderStr = getSafeGender(row[2]);
                var isPutra = genderStr.toLowerCase().includes("putra");
                var badgeClass = isPutra ? "bg-slate-200 text-slate-700" : (genderStr === "?" ? "bg-gray-100 text-gray-500" : "bg-red-100 text-red-700");
                var badgeLabel = isPutra ? "PA" : (genderStr === "?" ? "?" : "PI");
                
                var item = document.createElement('div');
                item.className = "p-3 flex justify-between items-center hover:bg-slate-50 border-b border-slate-100";
                
                var htmlStr = '<div class="flex items-center gap-3">';
                htmlStr += '<span class="' + badgeClass + ' px-2 py-1 rounded text-xs font-bold">' + badgeLabel + '</span>';
                htmlStr += '<div>';
                htmlStr += '<div class="font-bold text-sm text-slate-800">' + row[2] + '</div>';
                htmlStr += '<div class="text-xs text-slate-500">' + row[1] + ' ‚Ä¢ Nilai: <b class="text-blue-600">' + row[4] + '</b></div>';
                htmlStr += '</div></div>';
                htmlStr += '<button onclick="hapusData(\'' + row[5] + '\')" class="text-slate-300 hover:text-red-500 transition p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>';
                
                item.innerHTML = htmlStr;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderLiveKlasemenLocal() {
            var dataPa = getMatrixData('Putra').data;
            var dataPi = getMatrixData('Putri').data;
            
            fillTable('livePutra', dataPa); 
            fillTable('livePutri', dataPi);
        }

        function fillTable(elementId, dataArr) {
            var tbody = document.getElementById(elementId);
            tbody.innerHTML = "";
            var top5 = dataArr.slice(0, 5);
            if(top5.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-xs text-slate-400">Belum ada data</td></tr>'; 
                return; 
            }
            top5.forEach(function(row, idx) {
                var tr = '<tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">';
                tr += '<td class="p-3 text-center font-bold text-slate-400 text-xs">' + (idx+1) + '</td>';
                tr += '<td class="p-3"><div class="font-bold text-sm text-slate-700">' + row.nama + '</div><div class="text-[10px] text-slate-400">No. ' + row.noBarung + '</div></td>';
                tr += '<td class="p-3 text-right font-bold text-blue-600 text-sm">' + row.displayTotal + '</td>';
                tr += '</tr>';
                tbody.innerHTML += tr;
            });
        }

        function renderLiveMatrix() {
            var gender = document.getElementById('matrixLiveFilter').value;
            var matrix = getMatrixData(gender);
            var tamans = matrix.tamans;
            var data = matrix.data;
            
            var table = document.getElementById('liveMatrixTable');
            
            if(data.length === 0) {
                table.innerHTML = '<tr><td class="p-4 text-center text-slate-500">Belum ada data barung masuk.</td></tr>';
                return;
            }

            // Header (Posisinya RANGKING di ujung Kanan)
            var h = '<thead><tr class="bg-indigo-100 text-indigo-900 border-b border-indigo-200">';
            h += '<th class="p-2 border-r border-indigo-200 text-center w-12">NO</th>';
            h += '<th class="p-2 border-r border-indigo-200">BARUNG / PANGKALAN</th>';
            tamans.forEach(function(t) { h += '<th class="p-2 border-r border-indigo-200 text-center" title="'+t+'">' + t.substring(0,8) + '.</th>'; });
            h += '<th class="p-2 border-r border-indigo-200 text-center bg-indigo-200">TOTAL</th>';
            h += '<th class="p-2 text-center bg-yellow-100 text-yellow-800">RANK</th></tr></thead><tbody class="divide-y divide-slate-100">';
            
            // Body
            data.forEach(function(row, i) {
                h += '<tr class="hover:bg-slate-50">';
                h += '<td class="p-2 text-center font-bold text-slate-500 border-r border-slate-100">' + row.noBarung + '</td>';
                h += '<td class="p-2 border-r border-slate-100"><div class="font-bold text-slate-700">' + row.nama + '</div><div class="text-[10px] text-slate-400">' + row.pangkalan + '</div></td>';
                tamans.forEach(function(t) { 
                    var val = row.scores[t] === 0 ? '<span class="text-slate-300">-</span>' : row.scores[t];
                    h += '<td class="p-2 text-center border-r border-slate-100">' + val + '</td>'; 
                });
                h += '<td class="p-2 text-center font-bold text-blue-600 border-r border-slate-100 bg-blue-50/30">' + row.displayTotal + '</td>';
                h += '<td class="p-2 text-center font-black text-lg text-slate-800 bg-yellow-50/50">' + (i+1) + '</td>';
                h += '</tr>';
            });
            h += '</tbody>';
            table.innerHTML = h;
        }

        // --- PRINT & EXCEL LOGIC ---
        function renderDropdownPrint() {
            var selTaman = document.getElementById('selectTamanPrint');
            selTaman.innerHTML = '<option value="">Pilih Taman...</option>';
            masterTaman.forEach(function(t) { selTaman.innerHTML += '<option value="' + t[1] + '">' + t[1] + '</option>'; });
            
            var selBarung = document.getElementById('selectBarungPrint');
            selBarung.innerHTML = '<option value="">Pilih Barung...</option>';
            masterBarung.sort(function(a,b) { return a[1].localeCompare(b[1]); });
            masterBarung.forEach(function(b) { 
                var g = b[3] ? b[3] : "?";
                selBarung.innerHTML += '<option value="' + b[1] + '">' + b[1] + ' (' + g + ')</option>'; 
            });
        }

        function preparePrint(title, category) {
            document.getElementById('printTitle').innerText = title;
            document.getElementById('printCategory').innerText = category;
            document.getElementById('printDate').innerText = new Date().toLocaleString('id-ID');
            document.getElementById('printDateSign').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('printContent').innerHTML = "";
        }

        async function processRekap(gender, mode) {
            const res = await Swal.fire({title:'Proses Matriks ' + gender + '?', icon:'question', showCancelButton:true});
            if(!res.isConfirmed) return;

            var matrix = getMatrixData(gender);
            if(matrix.data.length === 0) { Swal.fire('Kosong', 'Tidak ada data.', 'warning'); return; }
            
            var tamans = matrix.tamans;
            var finalData = matrix.data;

            if(mode === 'print') {
                var h = '<table border="1" style="border-collapse:collapse;width:100%;font-family:Arial;font-size:11px;">';
                h += '<thead style="background:#ddd;"><tr><th style="width:30px;">NO</th><th>BARUNG</th><th>PANGKALAN</th>';
                tamans.forEach(function(t) { h += '<th>' + t + '</th>'; });
                h += '<th>TOTAL</th><th style="width:40px;">RANGKING</th></tr></thead><tbody>';
                
                finalData.forEach(function(row, i) {
                    h += '<tr>';
                    h += '<td style="text-align:center;">' + row.noBarung + '</td>';
                    h += '<td>' + row.nama + '</td>';
                    h += '<td>' + row.pangkalan + '</td>';
                    tamans.forEach(function(t) { 
                        var val = row.scores[t] || '-';
                        h += '<td style="text-align:center;">' + val + '</td>'; 
                    });
                    h += '<td style="text-align:center;font-weight:bold;">' + row.displayTotal + '</td>';
                    h += '<td style="text-align:center;font-weight:bold;font-size:12px;">' + (i+1) + '</td>';
                    h += '</tr>';
                });
                h += '</tbody></table>';

                preparePrint("MATRIKS REKAPITULASI NILAI AKHIR", "KATEGORI: " + gender.toUpperCase());
                document.getElementById('printContent').innerHTML = h;
                window.print();
            } 
            else if (mode === 'excel') {
                try {
                    // Header (RANGKING ditaruh paling kanan)
                    var header = ['NO UNDI', 'NAMA BARUNG', 'PANGKALAN'];
                    tamans.forEach(function(t) { header.push(t); });
                    header.push('TOTAL NILAI');
                    header.push('RANGKING');
                    
                    var dataRows = finalData.map(function(row, index) {
                        var rowData = [row.noBarung, row.nama, row.pangkalan];
                        tamans.forEach(function(t) { rowData.push(row.scores[t] || 0); });
                        rowData.push(row.displayTotal);
                        rowData.push(index + 1);
                        return rowData;
                    });
                    
                    var fullArray = [header].concat(dataRows);
                    var ws = XLSX.utils.aoa_to_sheet(fullArray);
                    var wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Rekap " + gender);
                    XLSX.writeFile(wb, "Rekap_Nilai_" + gender + "_Asli.xlsx");
                    
                } catch(err) {
                    Swal.fire('Error', 'Gagal membuat file Excel. Pastikan internet menyala.', 'error');
                }
            }
        }

        // Cetak Juara (Sudah pakai getMatrixData agar akurat)
        function printKlasemen(g) {
            var matrix = getMatrixData(g);
            if(matrix.data.length === 0) return alert("Kosong");
            
            preparePrint("KLASEMEN AKHIR JUARA", "KATEGORI " + g.toUpperCase());
            var h = '<table style="width:100%;border:1px solid #000;border-collapse:collapse;font-size:14px;">';
            h += '<thead><tr style="background:#eee;"><th>RANK</th><th>NO UNDI</th><th>BARUNG</th><th>PANGKALAN</th><th>TOTAL NILAI</th></tr></thead><tbody>';
            
            matrix.data.forEach(function(x,i) { 
                var bg = i < 3 ? "background:#fefce8;" : ""; // Highlight top 3
                h += '<tr style="'+bg+'">';
                h += '<td style="text-align:center;border:1px solid #000;font-weight:bold;font-size:16px;">' + (i+1) + '</td>';
                h += '<td style="text-align:center;border:1px solid #000;">' + x.noBarung + '</td>';
                h += '<td style="border:1px solid #000;font-weight:bold;">' + x.nama + '</td>';
                h += '<td style="border:1px solid #000;">' + x.pangkalan + '</td>';
                h += '<td style="text-align:center;border:1px solid #000;font-weight:bold;font-size:16px;">' + x.displayTotal + '</td>';
                h += '</tr>'; 
            });
            h += '</tbody></table>';
            document.getElementById('printContent').innerHTML = h;
            window.print();
        }

        function printRekapTaman() {
            var t = document.getElementById('selectTamanPrint').value;
            if(!t) return alert("Pilih Taman");
            preparePrint("REKAPITULASI NILAI POS", t.toUpperCase());
            
            var d = rawData.filter(function(x) { return x[1] === t; }).sort(function(a,b) { return b[4]-a[4]; });
            
            var h = '<table style="width:100%;border:1px solid #000;border-collapse:collapse;">';
            h += '<thead><tr style="background:#eee;"><th>RANGKING</th><th>NO UNDI</th><th>BARUNG</th><th>PANGKALAN</th><th>NILAI</th></tr></thead><tbody>';
            d.forEach(function(x,i) { 
                var bInfo = masterBarung.find(function(b) { return b[1] == x[2]; });
                var noUndi = bInfo ? bInfo[0] : "-";
                var pang = bInfo ? bInfo[2] : "-";
                
                h += '<tr>';
                h += '<td style="text-align:center;border:1px solid #000;font-weight:bold;">' + (i+1) + '</td>';
                h += '<td style="text-align:center;border:1px solid #000;">' + noUndi + '</td>';
                h += '<td style="border:1px solid #000;">' + x[2] + '</td>';
                h += '<td style="border:1px solid #000;">' + pang + '</td>';
                h += '<td style="text-align:center;border:1px solid #000;font-weight:bold;">' + x[4] + '</td>';
                h += '</tr>'; 
            });
            h += '</tbody></table>';
            document.getElementById('printContent').innerHTML = h;
            window.print();
        }

        function printRaporBarung() {
            var b = document.getElementById('selectBarungPrint').value;
            if(!b) return alert("Pilih Barung");
            var info = masterBarung.find(function(x) { return x[1] == b; });
            var gender = info && info[3] ? info[3] : "?"; 
            var sekolah = info ? info[2] : "";
            preparePrint("RAPOR HASIL LOMBA", "BARUNG: " + b + " (" + gender + ") - " + sekolah);
            
            var d = rawData.filter(function(x) { return x[2] === b; });
            var total = 0;
            
            var h = '<table style="width:100%;border:1px solid #000;border-collapse:collapse;">';
            h += '<thead><tr style="background:#eee;"><th style="width:50px;">NO</th><th>MATA LOMBA / POS</th><th>NILAI</th></tr></thead><tbody>';
            d.forEach(function(x, i) { 
                total += parseFloat(x[4]); 
                h += '<tr>';
                h += '<td style="text-align:center;border:1px solid #000;">' + (i+1) + '</td>';
                h += '<td style="border:1px solid #000;">' + x[1] + '</td>';
                h += '<td style="text-align:center;border:1px solid #000;">' + x[4] + '</td>';
                h += '</tr>'; 
            });
            var tDisplay = total % 1 !== 0 ? total.toFixed(1) : total;
            h += '<tr style="background:#eee;"><td colspan="2" style="text-align:right;border:1px solid #000;"><b>TOTAL NILAI AKHIR</b></td><td style="text-align:center;border:1px solid #000;font-size:16px;"><b>' + tDisplay + '</b></td></tr></tbody></table>';
            document.getElementById('printContent').innerHTML = h;
            window.print();
        }

        // --- UTILS ---
        function switchTab(t) {
            document.getElementById('tab-monitor').classList.add('hidden');
            document.getElementById('tab-laporan').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById('btn-monitor').className = "flex-1 py-2 px-4 rounded-lg font-bold text-sm text-slate-500 hover:text-slate-700 transition";
            document.getElementById('btn-laporan').className = "flex-1 py-2 px-4 rounded-lg font-bold text-sm text-slate-500 hover:text-slate-700 transition";
            document.getElementById('btn-'+t).className = "flex-1 py-2 px-4 rounded-lg font-bold text-sm bg-white shadow-sm text-red-600 transition";
        }

        async function hapusData(k) {
            const res = await Swal.fire({title: 'Hapus Data?', text: "Hanya untuk Admin!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'});
            if (!res.isConfirmed) return;
            try {
                await fetch(API_URL, {method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'delete', password: PASSWORD, kunci: k})});
                Swal.fire({icon: 'success', title: 'Terhapus', timer: 1000, showConfirmButton: false});
                loadAllData();
            } catch(e) { Swal.fire('Error', 'Gagal', 'error'); }
        }

        async function resetAllData() {
            const res = await Swal.fire({
                title: 'RESET DATA LOMBA?',
                text: "Ketik 'RESET' untuk hapus.",
                input: 'text', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'
            });
            if (res.value === 'RESET') {
                await fetch(API_URL, {method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'reset', password: PASSWORD})});
                Swal.fire('Selesai', 'Data direset', 'success').then(function() { location.reload(); });
            }
        }
    </script>
</body>
</html>
